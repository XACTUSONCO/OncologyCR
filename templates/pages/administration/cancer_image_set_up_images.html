{% extends "bases/base_generic.html" %}
{% load static %}

	{% block content %}
		<div class="page-content">
			<div class="container-fluid">
				<div class="bg-overlay bg-white"></div>

				<!-- start page title -->
				<div class="row">
					<div class="col-12">
						<div class="page-title-box d-flex align-items-center justify-content-between">
							<h2>Cancer Image Set-up</h2>

							<button id="print" type="button" class="btn btn-outline-secondary print_btn"><i class="bi bi-printer"></i> <span class="invisible-">화면 프린트</span></button>
							<div class="page-nav">
								<ul class="breadcrumb">
									<li class="breadcrumb-item"><a href="/"> <i class="bi bi-house"></i> </a></li>
									<li class="breadcrumb-item">Admin</li>
									<li class="breadcrumb-item">Cancer Image Set-up</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				<!-- end page title -->

                <!-- start sub-menu-tabs-->
				<div class="row">
					<div class="col-12">
						<div class="sub-menu-tabs">
							<ul id="submenu-tab">
								<li><a href="/administration/cancer_image_set_up/"><i></i> Page</a></li>
								<li><a href="/administration/cancer_image_set_up/images/"><i></i> Images</a></li>
								<li><a href="/administration/cancer_image_set_up/image_links/"><i></i> Image Links</a></li>
							</ul>
						</div>
					</div>
				</div>
				<!-- end sub-menu-tabs -->

                <!-- start contents-area -->
				<div class="row" id="printArea">
					<div class="col-12 education-datas">

                        <div class="row row-cols-auto select-action">
							<div class="col ms-auto">
								<button id="row-delete-button" type="button" class="btn btn-danger edit-btn px-4" onClick="handleClickDeleteSelection()" style="display: none">
									<i class="bi bi-trash"></i> <span>DELETE</span>
								</button>
								<button type="button" class="btn btn-success edit-btn px-4" onClick="handleClickAdd()">
									<i class="bi bi-plus-square"></i> <span>Add</span>
								</button>
							</div>
						</div>

                        <div class="table-responsive">
							<table class="table table-bordered custom-table" id="image-table">
								<thead>
                                    <tr>
                                        <th scope="col">삭제</th>
                                        <th scope="col" style="display:none;">#</th>
                                        <th scope="col">Research</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Screening</th>
                                        <th scope="col">Ongoing</th>
                                        <th scope="col">Enroll</th>
                                        <th scope="col">Target</th>
                                        <th scope="col">Cancer</th>
                                        <th scope="col">Slide number</th>
                                        <th scope="col"></th>
                                    </tr>
								</thead>
								<tbody>
								  {% for image in images %}
                                      <tr>
                                          <td style="cursor: pointer"></td>
                                          <th scope="row" style="display: none;">{{ image.id|default_if_none:"" }}</th>
                                          <td>{{ image.research.research_name|default_if_none:"" }}</td>
                                          <td>{{ image.m_name|default_if_none:"" }}</td>
                                          <td>{{ image.m_scr|default_if_none:"" }}</td>
                                          <td>{{ image.m_ongo|default_if_none:"" }}</td>
                                          <td>{{ image.m_enroll|default_if_none:"" }}</td>
                                          <td>{{ image.m_target|default_if_none:"" }}</td>
                                          <td>{{ image.cancer|default_if_none:"" }}</td>
                                          <td>{{ image.slide_number|default_if_none:"" }}</td>
                                          <td>
                                              <button type="button" class="btn btn-outline-secondary"
                                                      onClick="handleClickEdit('{{ image.research.id }}', '{{ image.cancer }}', '{{ image.m_name }}', '{{ image.m_scr }}', '{{ image.m_ongo }}', '{{ image.m_enroll }}', '{{ image.m_target }}', '{{ image.slide_number }}', '{{ image.id }}')">
                                                  수정
                                              </button>
                                          </td>
                                      </tr>
                                  {% endfor %}
								</tbody>
							</table>
						</div><!-- //table-responsive -->

                        {# 추가/수정 모달 #}
                        <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addModalLabel">Image 추가</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="post" action="/administration/cancer_image_set_up/images/" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        <input id="image-id" type="hidden" name="image_id"/>
                                        <input id="is-update" type="hidden" name="is_update"/>
                                        <div class="modal-body">
                                            <div class="form-group row">
                                                <label for="research" class="col-sm-3 col-form-label">Clinical trial</label>
                                                <div class="col-sm-9">
                                                    <select class="form-control" id="research" name="research"
                                                            required>
                                                        {% for research in researchs %}
                                                            <option value="{{ research.id }}">{{ research.research_name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="m_name" class="col-sm-3 col-form-label">Name</label>
                                                <div class="col-sm-9">
                                                    <input type="text" maxlength="50" class="form-control" id="m_name" name="m_name" required>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="m_scr" class="col-sm-3 col-form-label">Screening</label>
                                                <div class="col-sm-9">
                                                    <input type="text" maxlength="50" class="form-control" id="m_scr" name="m_scr">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="m_ongo" class="col-sm-3 col-form-label">Ongoing</label>
                                                <div class="col-sm-9">
                                                    <input type="text" maxlength="50" class="form-control" id="m_ongo" name="m_ongo">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="m_enroll" class="col-sm-3 col-form-label">Enroll</label>
                                                <div class="col-sm-9">
                                                    <input type="text" maxlength="50" class="form-control" id="m_enroll" name="m_enroll">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="m_target" class="col-sm-3 col-form-label">Target</label>
                                                <div class="col-sm-9">
													<select id="m_target" name="m_target" class="chosen form-control" required>
														<option value="">-------</option>
														{% for target in targets %}
															<option value="{{target.r_target}}" {% if target.r_target == value and target.research.id == researchId %} selected {% endif %} data-research-id="{{ target.research.id }}">
																{{ target.research.research_name }} -> {{target.r_target}}
															</option>
														{% endfor %}
													</select>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="cancer" class="col-sm-3 col-form-label">Cancer</label>
                                                <div class="col-sm-9">
                                                    <select class="form-control" id="cancer" name="cancer"
                                                            required>
                                                        {% for cancer in cancers %}
                                                            <option value="{{ cancer }}">{{ cancer }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="slide_number" class="col-sm-3 col-form-label">Slide number</label>
                                                <div class="col-sm-9">
                                                    <input type="number" class="form-control" id="slide_number" name="slide_number" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                                <i class="bi bi-arrow-left-square"></i> <span>Cancel</span>
                                            </button>
                                            <button type="submit" id="add-btn" class="btn btn-success edit-btn px-4">
                                                <i class="bi bi-pencil"></i> <span>Save</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
	{% endblock %}

{% block script %}
<script>
        $(document).ready(function () {
            const table = $('#image-table').DataTable({
                columnDefs: [
                    {
                        orderable: false,
                        className: 'select-checkbox',
                        targets: 0
                    },
                    {
                        targets: "_all",
                        className: "dt-center",
                    },

                ],
                select: {
                    style: 'multiple',
                    selector: 'td:first-child'
                },
                "order": [[1, "desc"]],
            })

            $('#image-table').data('selectedIds', []);

            table.on('select', function (e, dt, type, indexes) {
                const imageId = table.rows(indexes).data().toArray()[0][1];
                $('#image-table').data('selectedIds', [...$('#image-table').data('selectedIds'), imageId]);
                if ($('#image-table').data('selectedIds').length === 1) {
                    $('#row-delete-button').show();
                }
            });

            table.on('deselect', function (e, dt, type, indexes) {
                const imageId = table.rows(indexes).data().toArray()[0][1];
                const tmp = $('#image-table').data('selectedIds').filter(a => a !== imageId)
                $('#image-table').data('selectedIds', tmp);
                if (tmp.length === 0) {
                    $('#row-delete-button').hide();
                }
            });

            $('.dataTables_length').addClass('bs-select');

            $("#image-table_wrapper").css("width", "100%")

            $('#addModal').on('hide.bs.modal', () => {
                $('#is-update').val('');
                $('#image-id').val('');
                $('#research option:first-child').prop('selected', true);
                $('#cancer option:first-child').prop('selected', true);
                $('#m_name').val('');
                $('#m_scr').val('');
                $('#m_ongo').val('');
                $('#m_enroll').val('');
                $('#m_target').val('');
                $('#slide_number').val('');
            })
        });

        function handleClickAdd() {
            $('#addModalLabel').text('Image 추가');
            $('#is-update').val(false);
            $('#addModal').modal('show');
        }

        function handleClickEdit(researchId, cancer, m_name, m_scr, m_ongo, m_enroll, m_target, slideNumber, imageId) {
            $('#addModalLabel').text('Image 수정');
            $(`#research option[value=${researchId}]`).prop('selected', true);
            $(`#cancer option[value=${cancer}]`).prop('selected', true);
            $('#m_name').val(m_name);
            $('#m_scr').val(m_scr);
            $('#m_ongo').val(m_ongo);
            $('#m_enroll').val(m_enroll);
            $(`#m_target option[value="${m_target}"][data-research-id="${researchId}"]`).prop('selected', true);
            $('#slide_number').val(slideNumber);
            $('#image-id').val(imageId);
            $('#is-update').val('true');
            $('#addModal').modal('show');
        }

        function handleClickDeleteSelection() {
            const targetList = $('#image-table').data('selectedIds');
            if (confirm(`${targetList.length}개의 데이터를 삭제하시겠습니까?`)) {
                $.ajax({
                    type: 'post',
                    url: '/administration/cancer_image_set_up/images/delete/',
                    headers: {"X-CSRFTOKEN": "{{ csrf_token }}"},
                    data: {
                        "image_ids": targetList.join(","),
                    },
                    success: function () {
                        location.reload();
                    },
                });
            }
        }
</script>

<!-- studies 페이지용 js -->
<script src="{% static 'assets/js/pages/dashboard.js' %}"></script>
{% endblock %}
