{% extends "bases/base_generic.html" %}
{% load total_sum from research_tag %}
{% load get_item from research_tag %}
{% load static %}

	{% block content %}
		<div class="page-content">
			<div class="container-fluid">
				<div class="bg-overlay bg-white"></div>

				<!-- start page title -->
				<div class="row">
					<div class="col-12">
						<div class="page-title-box d-flex align-items-center justify-content-between">
							<h2>PI</h2>
							<button id="print" type="button" class="btn btn-outline-secondary print_btn"><i class="bi bi-printer"></i> <span class="invisible-">화면 프린트</span></button>

							<div class="page-nav">
								<ul class="breadcrumb">
									<li class="breadcrumb-item"><a href="/"> <i class="bi bi-house"></i> </a></li>
									<li class="breadcrumb-item">STAT</li>
									<li class="breadcrumb-item"><a href="#!">PI</a></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				<!-- end page title -->

				<!-- start sub-menu-tabs-->
				<div class="row">
					<div class="col-12">
						<div class="sub-menu-tabs">
							<!-- Nav tabs -->
							<ul id="submenu-tab" class="nav nav-tabs">
								<li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#status03_01">PI별 담당 연구 개수</a></li>
								<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#status03_02">교수별 Enroll 수 (월별)</a></li>
								<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#status03_03">PI별 진행 환자 수 (GRAPH)</a></li>
								<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#status03_04">PI별 진행 환자 수 (TABLE)</a></li>
							</ul>
						</div>
					</div>
				</div>
				<!-- end sub-menu-tabs -->

				<!-- start contents-area -->
				<div class="row" id="printArea">
					<div class="col-12">

						<!-- Tab panes -->
						<div class="tab-content">
							<div class="tab-pane active" id="status03_01">
								<div class="info-box3">
									<h3 class="tables-title">PI별 담당 연구 개수</h3>
									<div class="p-3">
										<div class="chart-box">
											<div id="PI_research_count_dashboard"></div>
										</div>
									</div>
								</div>
							</div>

							<div class="tab-pane fade" id="status03_02">
								<div class="pointtable-box mb-5">
									<h4 class="tables-title">교수별 Enroll 수 (월별)</h4>
									<div class="table-responsive colorTableStyle">
									  <table>
										<thead>
											<tr>
											  <th class="diagonal">
												<span class="crc">PI</span>
												<span class="month">Month</span>
												<div class="line"></div>
											  </th>
											  <th>Jan</th>
											  <th>Feb</th>
											  <th>Mar</th>
											  <th>Apr</th>
											  <th>May</th>
											  <th>Jun</th>
											  <th>Jul</th>
											  <th>Aug</th>
											  <th>Sept</th>
											  <th>Oct</th>
											  <th>Nov</th>
											  <th>Dec</th>
											  <th>개인별 합계</th>
											</tr>
										</thead>
										<tbody>
										  {% for monthly_enroll_by_PI_list in monthly_enroll_by_PI_list %}
										  <tr class="item">
											<td class="bg-warning name">{{ monthly_enroll_by_PI_list.0 }}</td>
											<td>{{ monthly_enroll_by_PI_list.1 }}</td>
											<td>{{ monthly_enroll_by_PI_list.2 }}</td>
											<td>{{ monthly_enroll_by_PI_list.3 }}</td>
											<td>{{ monthly_enroll_by_PI_list.4 }}</td>
											<td>{{ monthly_enroll_by_PI_list.5 }}</td>
											<td>{{ monthly_enroll_by_PI_list.6 }}</td>
											<td>{{ monthly_enroll_by_PI_list.7 }}</td>
											<td>{{ monthly_enroll_by_PI_list.8 }}</td>
											<td>{{ monthly_enroll_by_PI_list.9 }}</td>
											<td>{{ monthly_enroll_by_PI_list.10 }}</td>
											<td>{{ monthly_enroll_by_PI_list.11 }}</td>
											<td>{{ monthly_enroll_by_PI_list.12 }}</td>
											<td class="font-weight-bold" style="background-color: #fcb3cb;">{{ monthly_enroll_by_PI_list.13 }} 명 </td>
										  </tr>
										  {% endfor %}
										  <tr class="total">
											<td class="bg-info">월별 합계</td>
											{% with monthly_sum=monthly_enroll_by_PI_list|total_sum %}
											  <td class="bg-info">{{ monthly_sum.0 }}</td> <!-- 1월 합계 -->
											  <td class="bg-info">{{ monthly_sum.1 }}</td>
											  <td class="bg-info">{{ monthly_sum.2 }}</td>
											  <td class="bg-info">{{ monthly_sum.3 }}</td>
											  <td class="bg-info">{{ monthly_sum.4 }}</td>
											  <td class="bg-info">{{ monthly_sum.5 }}</td>
											  <td class="bg-info">{{ monthly_sum.6 }}</td>
											  <td class="bg-info">{{ monthly_sum.7 }}</td>
											  <td class="bg-info">{{ monthly_sum.8 }}</td>
											  <td class="bg-info">{{ monthly_sum.9 }}</td>
											  <td class="bg-info">{{ monthly_sum.10 }}</td>
											  <td class="bg-info">{{ monthly_sum.11 }}</td>
											{% endwith %}
											<td></td>
										  </tr>
										</tbody>
									  </table>
									</div>
								</div>
							</div>

							<div class="tab-pane fade" id="status03_03">
								<div class="info-box3">
									<h3 class="tables-title">PI별 진행 환자 수 (GRAPH)</h3>
									<div class="p-3">
										<div class="chart-box">
											<div id="N_of_ongoings_by_PI_CRC_dict_dashboard"></div>
										</div>
									</div>
								</div>
							</div>

							<div class="tab-pane fade" id="status03_04">
								{% for type_label, type_name in type_labels %}
								<div class="pointtable-box mb-5">
									<h4 class="tables-title">{{ type_name }}</h4>
									<div class="table-responsive colorTableStyle">
										<table>
											<thead>
												<tr>
													<th></th>
													{% for pi in N_of_ongoings_by_PI_CRC_list %}
														<th>{{ pi }}</th>
													{% endfor %}
												</tr>
											</thead>

											<tbody>
												{% for key, value in N_of_ongoings_by_PI_CRC_table_dict.items %}
												<tr class="item">
													<td class="bg-warning name">{{ key.0 }}</td>
													{% for count in value|get_item:type_label %}
														<td>{{ count }}</td>
													{% endfor %}
												</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	{% endblock %}

{% block script %}
<script>
    // PI별 진행 환자 수
    var N_of_ongoings_by_PI_CRC_option = {
      series: {{ series_js | safe }},
      chart: {
        type: "bar",
        height: 700,
        stacked: true,
      },
      stroke: {
        width: 1,
        colors: ['#fff']
      },
      dataLabels: {
	enabled: true,
        formatter: function (val) {
	    return val === 0 ? '' : val;
        },
        style: {
          fontSize: '10px',
          colors: ["#304758"]
        }
      },
      plotOptions: {
        bar: {
          horizontal: true
        }
      },
      xaxis: {
        categories: {{ pi_list | safe }},
      },
      fill: {
        opacity: 1,
      },
      colors: ['#008FFB', '#00E396', '#FEB019', '#FF4560', '#775DD0', '#bcf60c', '#6c757d', '#aab2bd'],
      legend: {
        show: false
      },
    };

    var N_of_ongoings_by_PI_CRC_dict = new ApexCharts(document.querySelector("#N_of_ongoings_by_PI_CRC_dict_dashboard"), N_of_ongoings_by_PI_CRC_option);
    N_of_ongoings_by_PI_CRC_dict.render();


    // PI별 담당 연구 개수
    var seriesData = [{% if is_recruiting_by_PI == 'Recruiting' or not is_recruiting_by_PI %}
        {
          name: 'IIT',
          data: {{ PI_research_count_dict.R_IIT | safe }}
        }, {
          name: 'SIT',
          data: {{ PI_research_count_dict.R_SIT | safe }}
        }, {
          name: 'PMS',
          data: {{ PI_research_count_dict.R_PMS | safe }}
        }, {
          name: 'EAP',
          data: {{ PI_research_count_dict.R_EAP | safe }}
        }, {
          name: 'Palliative',
          data: {{ PI_research_count_dict.R_Palliative | safe }}
        }, {
          name: 'Blood',
          data: {{ PI_research_count_dict.R_Blood | safe }}
        }, {
          name: 'ETC',
          data: {{ PI_research_count_dict.R_ETC | safe }}
        },{% elif is_recruiting_by_PI == 'ALL' %}
        {
          name: 'IIT',
          data: {{ PI_research_count_dict.IIT | safe }}
        }, {
          name: 'SIT',
          data: {{ PI_research_count_dict.SIT | safe }}
        }, {
          name: 'PMS',
          data: {{ PI_research_count_dict.PMS | safe }}
        }, {
          name: 'EAP',
          data: {{ PI_research_count_dict.EAP | safe }}
        }, {
          name: 'Palliative',
          data: {{ PI_research_count_dict.Palliative | safe }}
        }, {
          name: 'Blood',
          data: {{ PI_research_count_dict.Blood | safe }}
        }, {
          name: 'ETC',
          data: {{ PI_research_count_dict.ETC | safe }}
        },{% elif is_recruiting_by_PI == 'Holding' %}
        {
          name: 'IIT',
          data: {{ count_dict.H_IIT | safe }}
        }, {
          name: 'SIT',
          data: {{ PI_research_count_dict.H_SIT | safe }}
        }, {
          name: 'PMS',
          data: {{ PI_research_count_dict.H_PMS | safe }}
        }, {
          name: 'EAP',
          data: {{ PI_research_count_dict.H_EAP | safe }}
        }, {
          name: 'Palliative',
          data: {{ PI_research_count_dict.H_Palliative | safe }}
        }, {
          name: 'Blood',
          data: {{ PI_research_count_dict.H_Blood | safe }}
        }, {
          name: 'ETC',
          data: {{ PI_research_count_dict.H_ETC | safe }}
        },{% elif is_recruiting_by_PI == 'Completed' %}
        {
          name: 'IIT',
          data: {{ PI_research_count_dict.C_IIT | safe }}
        }, {
          name: 'SIT',
          data: {{ PI_research_count_dict.C_SIT | safe }}
        }, {
          name: 'PMS',
          data: {{ PI_research_count_dict.C_PMS | safe }}
        }, {
          name: 'EAP',
          data: {{ PI_research_count_dict.C_EAP | safe }}
        }, {
          name: 'Palliative',
          data: {{ PI_research_count_dict.C_Palliative | safe }}
        }, {
          name: 'Blood',
          data: {{ PI_research_count_dict.C_Blood | safe }}
        }, {
          name: 'ETC',
          data: {{ PI_research_count_dict.C_ETC | safe }}
        },{% elif is_recruiting_by_PI == 'Not yet recruiting' %}
        {
          name: 'IIT',
          data: {{ PI_research_count_dict.N_IIT | safe }}
        }, {
          name: 'SIT',
          data: {{ PI_research_count_dict.N_SIT | safe }}
        }, {
          name: 'PMS',
          data: {{ PI_research_count_dict.N_PMS | safe }}
        }, {
          name: 'EAP',
          data: {{ PI_research_count_dict.N_EAP | safe }}
        }, {
          name: 'Palliative,
          data: {{ PI_research_count_dict.N_Palliative | safe }}
        }, {
          name: 'Blood',
          data: {{ PI_research_count_dict.N_Blood | safe }}
        }, {
          name: 'ETC',
          data: {{ PI_research_count_dict.N_ETC | safe }}
        },{% endif %}
    ];
    var seriesTotals = seriesData.map((series) => {
      var total = series.data.reduce((acc, val) => acc + val, 0);
      return total
    });
    var PI_research_count_option = {
      chart: {
        type: "bar",
        height: 550,
        stacked: true,
        toolbar: {
          show: false
        },
        events: {
          mounted: (chartContext, config) => {
            console.log("mounted", chartContext, config, config.globals.yRange);
              addAnnotations_PI_research_count(config);
          },
          updated: (chartContext, config) => {
              addAnnotations_PI_research_count(config);
          }
        }
      },
      series: seriesData,
      dataLabels: {
        enabled: true,
        style: {
                fontSize: '10px',
                colors: ["#304758"]
            }
      },
      colors: ['#008FFB', '#00E396', '#FEB019', '#FF4560', '#775DD0', '#bcf60c', '#6c757d'],
      plotOptions: {
        bar: {
          columnWidth: '50%',
          dataLabels: {
            maxItems: 2,
            position: 'center',
          }
        }
      },
      xaxis: {
        categories: {{ PI | safe }},
        axisTicks: {
          show: true
        },
        axisBorder: {
          show: true
        },
        // floating: true,
        labels: {
          // maxHeight: 0,
          hideOverlappingLabels: false,
        }
      },
      yaxis: {
        axisTicks: {
          show: true
        },
        axisBorder: {
          show: true
        },
        labels: {
          hideOverlappingLabels: true,
        }
      },
      fill: {
        opacity: 1
      },
      legend: {
        position: "top",
        horizontalAlign: "left"
      },
      grid: {
        padding: {
          left: 13.5,
          right: 0
        },
        xaxis: {
            lines: {
                show: true
            }
        },
      }
    };

    var PI_research_count = new ApexCharts(document.querySelector("#PI_research_count_dashboard"), PI_research_count_option);
    PI_research_count.render();

    // PI별 담당 연구 개수 (Total 수에 대한 anotation)
    const addAnnotations_PI_research_count = (config) => {
      const seriesTotals = config.globals.stackedSeriesTotals;
      const isHorizontal = PI_research_count_option.plotOptions.bar.horizontal;
      PI_research_count.clearAnnotations();

      try {
        PI_research_count_option.xaxis.categories.forEach((category, index) => {
          PI_research_count.addPointAnnotation(
            {
              y: isHorizontal
                ? calcHorizontalY(config, index)
                : seriesTotals[index],
              x: isHorizontal ? 0 : category,
              label: {
                text: `${seriesTotals[index]}`
          }
            },
            false
          );

          if (isHorizontal) {
            adjustPointAnnotationXCoord(config, index);
          }
        });
      } catch (error) {
        console.log(`Add point annotation error: ${error.message}`);
      }
    };

    $(function() {
        $( "#strtDate" ).datepicker({
          dateFormat: "yy-mm-dd"
        });
        $( "#endDate" ).datepicker({
          dateFormat: "yy-mm-dd"
        });
    });
</script>

<!-- stat 페이지용 js -->
<script src="{% static 'assets/js/pages/stat.js' %}"></script>
<style>
  .line {
      position: absolute;
      height: 40px;
      top: 40px;
      bottom: 0;
      margin: auto;
      left: -5px;
      width: 100%;
      border-top: 1px solid #000;
      -webkit-transform: rotate(14deg);
      -ms-transform: rotate(14deg);
      transform: rotate(14deg);
    }
    .diagonal {
      width: 150px;
      height: 40px;
    }
    .diagonal span.crc {
      position: absolute;
      bottom: 2px;
      left: 6px;
    }
    .diagonal span.lab_technician {
      position: absolute;
      bottom: 2px;
      left: 6px;
    }
    .diagonal span.month {
      position: absolute;
      top: 2px;
      right: 6px;
    }
    .month-team-enroll td {
      border: 1px solid #000;
    }
    .month-team-enroll th {
      border: 1px solid #000;
    }
    #month-enroll-technician td {
      border: 1px solid #000;
    }
    #month-enroll-technician th {
      border: 1px solid #000;
    }
    .performance td {
      border: 1px solid #000;
    }
    .performance th {
      border: 1px solid #000;
    }
    #performance-2 td {
      border: 1px solid #000;
    }
    #performance-2 th {
      border: 1px solid #000;
    }
    #performance-3 td {
      border: 1px solid #000;
    }
    #performance-3 th {
      border: 1px solid #000;
    }
    .month-crc-visit td {
      border: 1px solid #000;
    }
    .month-crc-visit th {
      border: 1px solid #000;
    }


    .content {
      margin: 0;
      padding: 0;
    }
    .content::after {
      content: '';
      display: block;
      clear: both;
    }
    .content ul.menu {
      display: inline-flex;
      flex-flow: row wrap;
      width: 300px;
    }
    .content .menu li {
      width: 300px;
      height: 50px;
      text-align: center;
      line-height: 50px;
      border: 1px solid #000;
      box-sizing: border-box;
      margin-bottom: 1px;
      cursor: pointer;
    }
    .content .menu li:last-child {
      margin: 0;
    }
    .content .menu li.active {
      color: #fff;
      background: #000;
    }
    .content div.tab {
      width: 1300px;
      height: 100%;
      float: right;
      margin: 0px 10px;
    }
    .content>div>div {
      width: 100%;
      height: 100%;
      display: none;
    }
    .content>div>div.active {
      display: block;
    }

    .arrow {
      position: absolute;
      left: 70px;
    }

    .arrow::before,
    .arrow::after {
      position: relative;
      content: '';
      display: block;
      width: 10px;
      height: 1px;
      background: black;
      transition: 0.3s ease-in-out;
    }

    .arrow::before {
      transform: rotate(45deg);
    }
    .arrow::after {
      left: 6px;
      top: -1px;
      transform: rotate(-45deg);
    }

    .flip.active .arrow::before {
      transform: rotate(-45deg);
    }
    .flip.active .arrow::after {
      transform: rotate(45deg);
    }
</style>
{% endblock %}

<form action="/research/PI_statistic" method="GET" style="display: inline">
	<select name="is_recruiting_by_PI" id="is_recruiting_by_PI" class="ml-4">
		<option value="Recruiting" {% if is_recruiting_by_PI == "Recruiting" %} selected {% endif %}>Recruiting</option>
		<option value="Holding" {% if is_recruiting_by_PI == "Holding" %} selected {% endif %}>Holding</option>
		<option value="Completed" {% if is_recruiting_by_PI == "Completed" %} selected {% endif %}>Completed</option>
		<option value="Not yet recruiting" {% if is_recruiting_by_PI == "Not yet recruiting" %} selected {% endif %}>Not yet recruiting</option>
		<option value="ALL" {% if is_recruiting_by_PI == "ALL" %} selected {% endif %}>ALL</option>
	</select>
	<button class="btn btn-primary btn-xs" type="submit">조회</button>
</form>
